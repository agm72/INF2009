<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart Display Mirror</title>

  <!-- Bootstrap CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />

  <style>
    body {
      background-color: #f8f9fa;
      text-align: center;
      font-family: Arial, sans-serif;
    }
    .container {
      max-width: 600px;
      margin-top: 50px;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    .image-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 10px;
    }
    img {
      width: 120px;
      height: 120px;
      object-fit: cover;
      margin: 5px;
      border-radius: 10px;
    }
    .sensor-box {
      margin-top: 20px;
      padding: 15px;
      background: #ddd;
      border-radius: 10px;
      font-size: 20px;
    }
    .btn {
      width: 100%;
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <div class="container">
    {% if user %}
      <h2>Welcome, {{ user.name }}!</h2>

      <div class="video-container">
        <h4 class="mt-3">Live Camera Feed</h4>
        <img id="video-feed" src="{{ url_for('video_feed') }}" width="400">
      </div>

      <div class="sensor-box">
        <h4>Distance from Mirror:</h4>
        <p id="distance">Loading...</p>
      </div>

      <!-- Logout button (calls /logout via fetch JSON) -->
      <button id="logout-btn" class="btn btn-danger mt-3">Log Out</button>

    {% else %}
      <h1 class="mb-4">Smart Display Mirror</h1>

      <!-- 
        Instead of linking directly to /face-login (which triggers logic),
        we link to /face-login-page which just serves face_login.html.
      -->
      <a href="/face-login-page" class="btn btn-primary">Log In</a>
      <a href="/register" class="btn btn-success">Register</a>
    {% endif %}
  </div>

  <script>
    let sensorInterval;

    function fetchSensorData() {
      fetch('/sensor-data')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // If "distance" is valid
            if (data.distance !== undefined) {
              document.getElementById('distance').textContent = data.distance + " cm";
            }
          } else {
            // Show the error
            document.getElementById('distance').textContent = "Error: " + data.error;
          }
        })
        .catch(error => console.log("Error fetching sensor data:", error));
    }

    function startSensorFetching() {
      if ("{{ user }}" !== "None" && "{{ user }}" !== "") {
        console.log("User is logged in. Starting sensor fetching...");
        sensorInterval = setInterval(fetchSensorData, 5000); // fetch every 5 seconds
      }
    }

    function stopSensorFetching() {
      console.log("Stopping sensor fetching...");
      clearInterval(sensorInterval);
    }

    // On page load, if we have a user, start the sensor loop
    window.onload = function() {
      if ("{{ user }}") {
        startSensorFetching();
      } else {
        stopSensorFetching();
      }
    };

    // Handle logout via fetch
    document.addEventListener("DOMContentLoaded", function() {
      let logoutBtn = document.getElementById("logout-btn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", function() {
          fetch("/logout")
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                // Logged out, reload or redirect to home
                window.location.href = "/";
              } else {
                alert("Error logging out: " + data.error);
              }
            })
            .catch(err => console.error("Logout error:", err))
            .finally(() => {
              stopSensorFetching();
            });
        });
      }
    });
  </script>

</body>
</html>
