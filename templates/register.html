<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register</title>
    <link rel="stylesheet" 
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <h2 class="text-center">Register</h2>
        <form id="register-form" action="/register" method="POST">
            <div class="mb-3">
                <label for="username" class="form-label">Username</label>
                <input type="text" name="username" id="username" class="form-control" required>
            </div>
            
            <div class="mb-3">
                <button type="button" id="capture-btn" class="btn btn-primary">Capture Image</button>
                <button type="button" id="clear-btn" class="btn btn-danger">Clear All Images</button>
            </div>
            
            <div id="captured-images" class="mt-3"></div>
            
            <button type="submit" id="register-btn" class="btn btn-success w-100" disabled>Register</button>
        </form>
    </div>

    <script>
        let capturedImages = [];

        document.getElementById("clear-btn").addEventListener("click", function() {
            let username = document.getElementById("username").value.trim();
            if (!username) {
               alert("Enter a username first!");
               return;
            }

         fetch("/clear-images", {
             method: "POST",
             headers: { "Content-Type": "application/x-www-form-urlencoded" },
             body: `username=${username}`
         })
         .then(response => response.json())
         .then(data => {
             alert(data.message);
             document.getElementById("captured-images").innerHTML = "";
             capturedImages = [];
             enableInputs();
             validateImageCount();
         })
         .catch(err => console.error("Error clearing images:", err));
        });


        document.getElementById("capture-btn").addEventListener("click", function() {
            let username = document.getElementById("username").value;
            if (!username) {
                alert("Enter a username first!");
                return;
            }
            
            if (capturedImages.length >= 5) {
                alert("You must capture exactly 5 images.");
                return;
            }
            
            fetch("/capture", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `username=${username}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    let container = document.getElementById("captured-images");
                    let imgElement = document.createElement("img");
                    let imgPath = `/temp/${username}/${data.image}`;
                    imgElement.src = imgPath;
                    imgElement.width = 100;
                    imgElement.height = 100;
                    imgElement.style.margin = "5px";
                    container.appendChild(imgElement);
                    capturedImages.push(imgPath);
                    validateImageCount();
                }
            })
            .catch(err => console.error("Error capturing images:", err));
        });

        function validateImageCount() {
            const registerBtn = document.getElementById("register-btn");
            const captureBtn = document.getElementById("capture-btn");
            
            if (capturedImages.length === 5 && document.getElementById("username").value.trim() !== "") {
                registerBtn.disabled = false;
                captureBtn.disabled = true;
            } else {
                registerBtn.disabled = true;
                captureBtn.disabled = false;
            }
        }

        function enableInputs() {
            document.getElementById("capture-btn").disabled = false;
            document.getElementById("register-btn").disabled = true;
        }

        document.getElementById("register-form").addEventListener("submit", function(event) {
            if (document.getElementById("username").value.trim() === "" || capturedImages.length !== 5) {
                event.preventDefault();
                alert("Please capture exactly 5 images before registering.");
            }
        });
    </script>
</body>
</html>
